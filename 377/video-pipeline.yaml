AWSTemplateFormatVersion: "2010-09-09"
# Transform: Count

Parameters:

  Prefix:
    Type: String
    Default: Tie002
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*
    Description: Prefix to append to all Names Created ; expected value example "TieLine002"

  AZ1:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: us-west-2a
    Description: Target AZ for first HA deployment - IMPORTANT this MUST match the target Subnet for SUBNET1a-b

  Subnet1:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-feb95286
    Description: Subnet(s) to deploy API Gateway Interface endpoint, This MUST match the target for AZ1 and should be private

  AZ2:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: us-west-2b
    Description: WILL NOT BE USED - See email confluence docs for details - Target AZ for second HA deployment - IMPORTANT this MUST match the target Subnet for SUBNET2a-b

  Subnet2:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-a5eaffee
    Description: Subnet(s) to deploy API Gateway Interface endpoint, This MUST match the target for AZ2 and should be private

  IAMRoleForMediaLive:
    Type: String
    Default: MediaLiveAccessRole
    Description: Target Role to assign to MediaLive

  IAMRoleForMediaConnectToCreateInVPC:
    Type: String
    Default: MediaConnectFullAccessToVPC
    Description: Role for MediaConnect to assume in order to create VPC resources

  MediaLiveSGs:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Target SGs to apply to MediaLive Inputs

  MediaConnectInterfaceSG:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Target SGs to apply to MediaConnect VPC endpoints

  InputProtocol:
    Type: String
    Default: zixi-push
    AllowedValues:
      - "zixi-push"
      - "rtp-fec"
      - "rtp"
      - "rist"
    Description: Target input protocol that is expected from the source stream (if UDP - you will need a zixi conversion ec2, and this will be zixi-push)

  ThumbnailBucket:
    Type: String
    Description: Please enter the S3 bucket name that MediaLive will output its JPEG outputs to. This S3 Bucket MUST be the bucket deployed by the operator dashboard CloudFormation Template

Resources:
###
### MediaConnect
###
  MediaFlowIn1:
    Type: AWS::MediaConnect::Flow
    Properties:
      AvailabilityZone: !Ref AZ1
      Name: !Sub "${Prefix}MediaFlowIn"
      Source:
        Name: !Sub "${Prefix}MediaFlowIn"
        Protocol: zixi-push
        WhitelistCidr: 0.0.0.0/0

  EMX1Interface1:
    Type: AWS::MediaConnect::FlowVpcInterface
    Properties:
      FlowArn: !Ref MediaFlowIn1
      Name: !Sub "${Prefix}-iface-${AZ1}-${Subnet1}"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaConnectToCreateInVPC}"
      SecurityGroupIds: !Ref MediaConnectInterfaceSG
      SubnetId: !Ref Subnet1

  MediaFlowOut1:
    Type: AWS::MediaConnect::Flow
    Properties:
      AvailabilityZone: !Ref AZ1
      Name: !Sub "${Prefix}MediaFlowOut"
      Source:
        Name: !Sub "${Prefix}MediaFlowOut"
        Protocol: rtp-fec
        WhitelistCidr: 0.0.0.0/0

  EMX1Interface2:
    Type: AWS::MediaConnect::FlowVpcInterface
    Properties:
      FlowArn: !Ref MediaFlowOut1
      Name: !Sub "${Prefix}-iface-${AZ1}-${Subnet1}"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaConnectToCreateInVPC}"
      SecurityGroupIds: !Ref MediaConnectInterfaceSG
      SubnetId: !Ref Subnet1

###
### MediaLive
###
  ML1EMXInputProxy:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-from-MediaConnect-proxy"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: RTP_PUSH
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2

  ML1EMXInputDistribution:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-from-MediaConnect-distribution"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: RTP_PUSH
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2

  ML1MP4L:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-MP4L"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: MP4_FILE
      Sources:
        - Url: s3://$urlPath$

  ML1MP4C:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-MP4C"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: MP4_FILE
      Sources:
        - Url: s3://$urlPath$
        
  MediaLiveChannelDistribution:
    Type: 'AWS::MediaLive::Channel'
    Properties:
      Name: !Sub ${Prefix}-Distribution
      ChannelClass: SINGLE_PIPELINE
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_50_MBPS
        Resolution: HD
      LogLevel: DISABLED
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
        - !Ref Subnet1
      InputAttachments:
        - InputId: !Ref ML1EMXInputDistribution
          InputAttachmentName: MainStream
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
        - InputId: !Ref ML1MP4L
          InputAttachmentName: LoopMP4
          InputSettings:
            SourceEndBehavior: LOOP
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
        - InputId: !Ref ML1MP4C
          InputAttachmentName: ContinueMP4
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
      Destinations:
        - Id: udp1
          Settings:
            - Url: !Sub "rtp://${MediaFlowOut1.Source.IngestIp}:5000"
        - Id: udp2
          Settings:
            - Url: !Sub "rtp://ec2-streamer-ip-in-subnet-${Subnet1}:21010"
        - Id: jpgoutputs3
          Settings:
            - Url: !Sub "s3ssl://${ThumbnailBucket}/status_thumbnails/${Prefix}"
      EncoderSettings:
        FeatureActivations:
          InputPrepareScheduleActions: ENABLED
        AudioDescriptions:
          - Name: audio_0
            AudioSelectorName: ap1
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_1
            AudioSelectorName: ap2
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_2
            AudioSelectorName: ap3
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_3
            AudioSelectorName: ap4
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_4
            AudioSelectorName: ap5
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_5
            AudioSelectorName: ap6
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_6
            AudioSelectorName: ap7
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_7
            AudioSelectorName: ap8
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              Mp2Settings:
                CodingMode: CODING_MODE_2_0
                Bitrate: 192000
                SampleRate: 48000
          - Name: audio_proxy
            AudioSelectorName: ap1
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: IGNORE
                AdaptiveQuantization: AUTO
                Bitrate: 20000000
                EntropyEncoding: CABAC
                FlickerAq: ENABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopSize: 2
                GopSizeUnits: SECONDS
                SubgopLength: FIXED
                ScanType: INTERLACED
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: MEDIUM
                NumRefFrames: 1
                ParControl: INITIALIZE_FROM_SOURCE
                Profile: HIGH
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: PIC_TIMING_SEI
                QualityLevel: ENHANCED_QUALITY
                FilterSettings:
                  TemporalFilterSettings:
                    PostFilterSharpening: AUTO
                    Strength: AUTO
            Name: rtp-distribution
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: IGNORE
                AdaptiveQuantization: LOW
                Bitrate: 250000
                EntropyEncoding: CABAC
                FlickerAq: ENABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopSize: 2
                GopSizeUnits: SECONDS
                SubgopLength: FIXED
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: LOW
                NumRefFrames: 1
                ParControl: INITIALIZE_FROM_SOURCE
                Profile: MAIN
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: DISABLED
                QualityLevel: STANDARD_QUALITY
            Height: 360
            Name: rtp-proxy
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 640
          - CodecSettings:
              FrameCaptureSettings:
                CaptureInterval: 2
                CaptureIntervalUnits: SECONDS
            Height: 360
            Width: 640
            Name: jpg-output-video
        CaptionDescriptions: []
        OutputGroups:
          - Name: frame-capture
            OutputGroupSettings:
              FrameCaptureGroupSettings:
                Destination:
                  DestinationRefId: jpgoutputs3
            Outputs:
              - OutputName: jpg-output
                VideoDescriptionName: jpg-output-video
                OutputSettings:
                  FrameCaptureOutputSettings:
                    NameModifier: ""
          - Name: rtp
            OutputGroupSettings:
              UdpGroupSettings:
                InputLossAction: EMIT_PROGRAM
            Outputs:
              - OutputName: rtp-distribution
                VideoDescriptionName: rtp-distribution
                AudioDescriptionNames:
                  - audio_0
                  - audio_1
                  - audio_2
                  - audio_3
                  - audio_4
                  - audio_5
                  - audio_6
                  - audio_7
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 1000
                    Destination:
                      DestinationRefId: udp1
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        ProgramNum: 1
                        Scte35Control: PASSTHROUGH
              - OutputName: rtp-proxy
                VideoDescriptionName: rtp-proxy
                AudioDescriptionNames:
                  - audio_proxy
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 100
                    Destination:
                      DestinationRefId: udp2
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        ProgramNum: 1
                        Scte35Control: PASSTHROUGH
        TimecodeConfig:
          Source: EMBEDDED
      Tags:
        Bumpers: Bumpers

  MediaLiveChannelProxy:
    Type: 'AWS::MediaLive::Channel'
    Properties:
      Name: !Sub ${Prefix}-Proxy
      ChannelClass: SINGLE_PIPELINE
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_50_MBPS
        Resolution: HD
      LogLevel: DISABLED
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
      InputAttachments:
        - InputId: !Ref ML1EMXInputProxy
          InputAttachmentName: MainStream
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
      Destinations:
        - Id: udp1
          Settings:
            - Url: !Sub "rtp://ec2-streamer-ip-in-subnet-${Subnet1}:20010"
      EncoderSettings:
        AudioDescriptions:
          - Name: audio_0
            AudioSelectorName: ap1
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: IGNORE
                AdaptiveQuantization: AUTO
                Bitrate: 250000
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopSize: 2
                GopSizeUnits: SECONDS
                SubgopLength: FIXED
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: LOW
                NumRefFrames: 1
                ParControl: INITIALIZE_FROM_SOURCE
                Profile: MAIN
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: DISABLED
                QualityLevel: STANDARD_QUALITY
            Height: 360
            Name: rtp-proxy
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 640
        CaptionDescriptions: []
        OutputGroups:
          - Name: rtp
            OutputGroupSettings:
              UdpGroupSettings:
                InputLossAction: EMIT_PROGRAM
            Outputs:
              - OutputName: rtp-proxy
                VideoDescriptionName: rtp-proxy
                AudioDescriptionNames:
                  - audio_0
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 100
                    Destination:
                      DestinationRefId: udp1
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        ProgramNum: 1
                        Scte35Control: PASSTHROUGH
        TimecodeConfig:
          Source: EMBEDDED
      Tags:
        Bumpers: Bumpers