AWSTemplateFormatVersion: "2010-09-09"
# Transform: Count

Parameters:

  Prefix:
    Type: String
    Default: Tie002
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*
    Description: Prefix to append to all Names Created

  AZ1:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: us-west-2a
    Description: Target AZ for first HA deployment - IMPORTANT this MUST match the target Subnet for SUBNET1a-b

  Subnet1:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-feb95286
    Description: Subnet(s) to deploy API Gateway Interface endpoint, This MUST match the target for AZ1 and should be private

  AZ2:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: us-west-2b
    Description: WILL NOT BE USED - See email confluence docs for details - Target AZ for second HA deployment - IMPORTANT this MUST match the target Subnet for SUBNET2a-b

  Subnet2:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-a5eaffee
    Description: Subnet(s) to deploy API Gateway Interface endpoint, This MUST match the target for AZ2 and should be private

  IAMRoleForMediaLive:
    Type: String
    Default: MediaLiveAccessRole
    Description: Target Role to assign to MediaConnect

  IAMRoleForMediaConnectToCreateInVPC:
    Type: String
    Default: arn:aws:iam::301520684698:role/MediaConnectFullAccessToVPC
    Description: Role for MediaConnect to assume in order to create VPC resources

  MediaLiveSGs:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Target SGs to apply to MediaLive Inputs

  InputProtocol:
    Type: String
    Default: zixi-push
    AllowedValues:
      - "zixi-push"
      - "rtp-fec"
      - "rtp"
      - "rist"
    Description: Target input protocol that is expected from the source stream (if UDP - you will need a zixi conversion ec2, and this will be zixi-push)

Resources:

  MediaFlowIn1:
    Type: AWS::MediaConnect::Flow
    Properties:
      AvailabilityZone: !Ref AZ1
      Name: !Sub "${Prefix}MediaFlowIn"
      Source:
        Name: !Sub "${Prefix}MediaFlowIn"
        Protocol: rtp
        WhitelistCidr: 0.0.0.0/0

  MediaFlowOut1:
    Type: AWS::MediaConnect::Flow
    Properties:
      AvailabilityZone: !Ref AZ1
      Name: !Sub "${Prefix}MediaFlowOut"
      Source:
        Name: !Sub "${Prefix}MediaFlowOut"
        Protocol: rtp
        WhitelistCidr: 0.0.0.0/0

  ML1EMXInputProxy:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-from-MediaConnect-proxy"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: RTP_PUSH
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2

  ML1EMXInputDistribution:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-from-MediaConnect-distribution"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: RTP_PUSH
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2

  ML1MP4L:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-MP4L"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: MP4_FILE
      Sources:
        - Url: s3://$urlPath$

  ML1MP4C:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub "${Prefix}-MP4C"
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Type: MP4_FILE
      Sources:
        - Url: s3://$urlPath$
        
  MediaLiveChannelDistribution:
    Type: 'AWS::MediaLive::Channel'
    Properties:
      Name: !Sub ${Prefix}-Distribution
      ChannelClass: SINGLE_PIPELINE
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_50_MBPS
        Resolution: HD
      LogLevel: DISABLED
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
        - !Ref Subnet1
      InputAttachments:
        - InputId: !Ref ML1EMXInputDistribution
          InputAttachmentName: MainStream
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
        - InputId: !Ref ML1MP4L
          InputAttachmentName: LoopMP4
          InputSettings:
            SourceEndBehavior: LOOP
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
        - InputId: !Ref ML1MP4C
          InputAttachmentName: ContinueMP4
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
      Destinations:
        - Id: udp1
          Settings:
            - Url: !Sub "rtp://${MediaFlowOut1.Source.IngestIp}:5000"
        - Id: udp2
          Settings:
            - Url: !Sub "rtp://ec2-streamer-ip-in-subnet-${Subnet1}:20110"
      EncoderSettings:
        AudioDescriptions:
          - Name: audio_0
            AudioSelectorName: ap1
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_1
            AudioSelectorName: ap2
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_2
            AudioSelectorName: ap3
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_3
            AudioSelectorName: ap4
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_4
            AudioSelectorName: ap5
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_5
            AudioSelectorName: ap6
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_6
            AudioSelectorName: ap7
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
          - Name: audio_7
            AudioSelectorName: ap7
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                #Bitrate: 4500000
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                #FramerateNumerator: 30000
                #FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 2
                GopSize: 60
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_4_1
                LookAheadRateControl: MEDIUM
                NumRefFrames: 1
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 4
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: DISABLED
                QualityLevel: ENHANCED_QUALITY
                FilterSettings:
                  TemporalFilterSettings:
                    PostFilterSharpening: AUTO
                    Strength: AUTO
            #Height: 720
            Name: rtp-distribution
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            #Width: 1280
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: LOW
                Bitrate: 500000
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                #FramerateNumerator: 30000
                #FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 2
                GopSize: 60
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: INTERLACED
                #Level: H264_LEVEL_4_1
                LookAheadRateControl: LOW
                NumRefFrames: 1
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 4
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: DISABLED
                QualityLevel: STANDARD_QUALITY
            Height: 360
            Name: rtp-proxy
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 640
        CaptionDescriptions: []
        OutputGroups:
          - Name: rtp
            OutputGroupSettings:
              UdpGroupSettings:
                InputLossAction: EMIT_PROGRAM
            Outputs:
              - OutputName: rtp-distribution
                VideoDescriptionName: rtp-distribution
                AudioDescriptionNames:
                  - audio_0
                  - audio_1
                  - audio_2
                  - audio_3
                  - audio_4
                  - audio_5
                  - audio_6
                  - audio_7
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 50
                    Destination:
                      DestinationRefId: udp1
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        Bitrate: 0  
              - OutputName: rtp-proxy
                VideoDescriptionName: rtp-proxy
                AudioDescriptionNames:
                  - audio_0
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 50
                    Destination:
                      DestinationRefId: udp2
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        Bitrate: 0                        
        TimecodeConfig:
          Source: EMBEDDED
      Tags:
        MediaLive-Workflow: test

  MediaLiveChannelProxy:
    Type: 'AWS::MediaLive::Channel'
    Properties:
      Name: !Sub ${Prefix}-Proxy
      ChannelClass: SINGLE_PIPELINE
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_50_MBPS
        Resolution: HD
      LogLevel: DISABLED
      RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/${IAMRoleForMediaLive}"
      Vpc:
        SecurityGroupIds: !Ref MediaLiveSGs
        SubnetIds:
          - !Ref Subnet1
      InputAttachments:
        - InputId: !Ref ML1EMXInputProxy
          InputAttachmentName: MainStream
          InputSettings:
            SourceEndBehavior: CONTINUE
            AudioSelectors:
              - Name: ap1
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 1
              - Name: ap2
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 2
              - Name: ap3
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 3
              - Name: ap4
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 4
              - Name: ap5
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 5
              - Name: ap6
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 6
              - Name: ap7
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 7
              - Name: ap8
                SelectorSettings:
                  AudioTrackSelection:
                    Tracks:
                      - Track: 8
      Destinations:
        - Id: udp1
          Settings:
            - Url: !Sub "rtp://ec2-streamer-ip-in-subnet-${Subnet1}:20010"
      EncoderSettings:
        AudioDescriptions:
          - Name: audio_0
            AudioSelectorName: ap1
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: LOW
                Bitrate: 500000
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: INITIALIZE_FROM_SOURCE
                #FramerateNumerator: 30000
                #FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 2
                GopSize: 60
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: INTERLACED
                #Level: H264_LEVEL_4_1
                LookAheadRateControl: LOW
                NumRefFrames: 1
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: CBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 4
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeInsertion: DISABLED
                QualityLevel: STANDARD_QUALITY
            Height: 360
            Name: rtp-proxy
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 640
        CaptionDescriptions: []
        OutputGroups:
          - Name: rtp
            OutputGroupSettings:
              UdpGroupSettings:
                InputLossAction: EMIT_PROGRAM
            Outputs:
              - OutputName: rtp-proxy
                VideoDescriptionName: rtp-proxy
                AudioDescriptionNames:
                  - audio_0
                CaptionDescriptionNames: []
                OutputSettings:
                  UdpOutputSettings:
                    BufferMsec: 50
                    Destination:
                      DestinationRefId: udp1
                    FecOutputSettings:
                      IncludeFec: COLUMN_AND_ROW
                      ColumnDepth: 10
                      RowLength: 10
                    ContainerSettings:
                      M2tsSettings:
                        Bitrate: 0
        TimecodeConfig:
          Source: EMBEDDED
      Tags:
        MediaLive-Workflow: test